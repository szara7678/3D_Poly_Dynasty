## 몬스터 렌더링 이동 시스템 개선 작업 중 발생한 문제들 (2024-12-19)

### 1. 몬스터의 급격한 이동 문제
**문제**: 몬스터가 순식간에 가속하면서 슉슉 움직이는 현상
**해결**: 
- 몬스터 렌더링에서 시민과 다른 이동 처리 사용
- 시민: 예측 이동으로 부드럽게 이동
- 몬스터: 단순한 스무딩으로 급격하게 이동

### 2. 렌더링 시스템의 이동 로직 차이 문제
**문제**: 시민과 몬스터가 다른 렌더링 이동 로직을 사용
**해결**:
- 몬스터도 시민과 동일한 예측 이동 방식 적용
- 목표가 있을 때: `spd * dtRender` 속도로 부드럽게 이동
- 목표가 없을 때: 현재 위치로 천천히 수렴

### 3. 시각적 일관성 문제
**문제**: 시민과 몬스터의 이동 패턴이 시각적으로 다름
**해결**:
- AGI 기반 속도 계산: `spd = 2.2 * (0.9 + AGI*0.02)`
- 부드러운 지상 높이 수렴: `0.15` 비율
- 정지 시 위치 수렴: `0.28` 비율
- 시민과 완전히 동일한 이동 로직 적용

---

## 몬스터 이동 시스템 개선 작업 중 발생한 문제들 (2024-12-19)

### 1. 몬스터와 시민의 이동 시스템 차이점 문제
**문제**: 몬스터는 목표 변경 시 이전 목표에 도달한 후에야 새로운 목표로 이동하는 반면, 시민은 즉시 새로운 목표로 이동
**해결**: 
- 몬스터 이동 시스템에서 `isAtTarget` 함수 제거
- 목표 도달 시 즉시 새로운 목표 설정하도록 수정
- 시민과 동일한 즉시 반응 방식으로 변경

### 2. 목표 변경 시 순식간 도착 현상 문제
**문제**: 몬스터가 다음 목표를 찍으면 이전 목표에 순식간에 도착한 이후에 출발하는 현상
**해결**:
- `isAtTarget` 함수를 사용한 도달 확인 로직 제거
- `moveEntity` 함수의 반환값(`isMoving`)을 사용하여 이동 완료 감지
- 이동 완료 시 즉시 새로운 목표 설정

### 3. 이동 로직 복잡성 문제
**문제**: 불필요한 `isAtTarget` 함수로 인한 로직 복잡성
**해결**:
- `isAtTarget` 함수 완전 제거
- 이동 로직 단순화: 목표 없음 → 새 목표 설정, 이동 완료 → 새 목표 설정
- 랜덤 목표 변경 확률은 유지하여 자연스러운 배회 유지

---

## 몬스터 이동 속도 조정 작업 중 발생한 문제들 (2024-12-19)

### 1. 몬스터 이동 속도 과다 문제
**문제**: 몬스터들이 너무 빠르게 움직여서 시민과의 균형이 맞지 않음
**해결**: 
- 몬스터 이동 시스템 확인 결과 이미 시민과 동일한 시스템 사용
- AGI에 따른 속도 계산도 이미 적용되어 있음
- 문제는 몬스터의 AGI 스탯이 너무 높아서 발생

### 2. AGI 스탯 불균형 문제
**문제**: 고블린과 오크의 AGI 스탯이 시민보다 높아서 이동 속도가 과도함
**해결**:
- 고블린 AGI: 4~9 → 2~5로 조정
- 오크 AGI: 3~8 → 2~5로 조정
- 시민의 기본 AGI(5)와 비슷한 수준으로 맞춤

### 3. 속도 계산 공식 확인
**문제**: 속도 계산 공식이 올바르게 적용되고 있는지 확인 필요
**해결**:
- `moveEntity` 함수에서 `speed = speedBase * (0.8 + agility * 0.04)` 공식 사용
- AGI 2~5 범위에서 적절한 속도 차이 제공
- 시민과 몬스터 모두 동일한 공식 사용으로 일관성 확보

---

## 고블린 건물 타입 명확화 작업 중 발생한 문제들 (2024-12-19)

### 1. 건물 타입 일관성 문제
**문제**: 고블린 건물이 `monster_den` 타입으로 되어 있어 오크와의 구분이 모호함
**해결**: 
- 모든 관련 파일에서 `monster_den`을 `goblin_den`으로 변경
- 건물 정의, 렌더링 시스템, 군락지 관리 시스템, 초기화 시스템 모두 일관되게 수정

### 2. 렌더링 시스템 타입 누락 문제
**문제**: `BuildingManager`와 `BlueprintManager`에서 `goblin_den` 타입이 정의되지 않아 렌더링 불가
**해결**:
- `BuildingManager.js`에 `goblin_den` 타입 정의 추가
- `BlueprintManager.js`에 `goblin_den` 타입 정의 추가
- 고블린 군락과 오크 군락의 시각적 구분을 위한 색상 차별화

### 3. 초기화 시스템 타입 불일치 문제
**문제**: 초기화 시스템에서 여전히 `monster_den` 타입을 사용하여 일관성 부족
**해결**:
- `state.js`의 `initializeMonsterSystem`에서 `goblin_den` 타입 사용
- `monsterNestManager.js`의 기본 타입을 `goblin_den`으로 변경

---

## 초기 몬스터 군락지 배치 개선 작업 중 발생한 문제들 (2024-12-19)

### 1. 초기 군락지 다양성 부족 문제
**문제**: 게임 시작 시 고블린 군락만 생성되어 오크와의 전투 상황이 부족함
**해결**: 
- `initializeMonsterSystem` 함수에서 고블린 군락과 오크 군락을 각각 생성
- 고블린 군락: `monster_den` 타입, 팀 1
- 오크 군락: `orc_den` 타입, 팀 2
- 각각 독립적인 위치에 배치하여 다양한 전투 상황 제공

### 2. 군락지 타입별 초기화 문제
**문제**: 기존 시스템이 고블린 군락만 지원하여 오크 군락 초기화 불가
**해결**:
- `createRandomNest` 함수에 `nestType` 매개변수 활용
- 각 군락지 타입에 맞는 적절한 팀 번호 할당
- 각 군락지에서 해당 종족의 몬스터가 자동으로 생산되도록 설정

---

## 몬스터 타입 구분 시스템 개선 작업 중 발생한 문제들 (2024-12-19)

### 1. 타입 구분의 모호성 문제
**문제**: 기존 시스템에서 `monster`와 `orc`로 구분하여 고블린이 `monster` 타입으로 처리됨
**해결**: 
- 고블린의 타입을 `goblin`으로 명확히 구분
- 생산 시스템에서 `goblin`과 `orc` 자원 타입으로 명확히 구분
- 건물 정의에서 `monster` 생산을 `goblin` 생산으로 변경

### 2. 생산 시스템 타입 처리 문제
**문제**: 생산 시스템에서 `monster` 타입으로 처리되어 고블린과 오크 구분이 모호함
**해결**:
- `production.js`에서 `goblin`과 `orc` 자원 타입으로 명확히 구분
- 생산 진행률과 생산량 계산에서 각각 독립적으로 처리
- 몬스터 생산 처리 로직에서 `goblin`/`orc` 타입으로 분기

---

## 오크 시스템 추가 및 몬스터 시스템 확장 작업 중 발생한 문제들 (2024-12-19)

### 1. 몬스터 타입별 홈 군락지 추적 문제
**문제**: 기존 시스템이 고블린만 지원하여 오크의 홈 군락지 추적 불가
**해결**: 
- `orcHomeNests` Map 추가
- `setOrcHomeNest`, `getOrcHomeNest` 함수 추가
- `setRandomTarget` 함수에서 몬스터 타입별 홈 군락지 처리

### 2. 생산 시스템 확장 문제
**문제**: 기존 생산 시스템이 `monster` 자원만 지원
**해결**:
- `production.js`에서 `orc` 자원 생산 지원 추가
- 생산 진행률과 생산량 계산에서 `orc` 포함
- `monsterNestManager.produceMonster` 함수로 통합 생산

### 3. 건물 정의 확장 문제
**문제**: 새로운 몬스터 타입을 위한 건물 정의 필요
**해결**:
- `_defs.sample.js`에 `orc_den` 건물 정의 추가
- 오크 군락은 고블린 군락보다 강한 스펙 (HP 350, 건설 시간 4초)
- 12초마다 오크 생산으로 고블린(10초)보다 느린 생산 속도

### 4. MonsterNestManager 확장 문제
**문제**: 기존 매니저가 고블린만 지원
**해결**:
- `createNest` 함수에 `nestType` 매개변수 추가
- `produceMonster` 함수로 고블린/오크 통합 생산
- 건물 타입에 따른 몬스터 생산 로직 분기

---

## 몬스터 군락지 관리 시스템 분리 및 최적화 작업 중 발생한 문제들 (2024-12-19)

### 1. 순환 참조 문제
**문제**: state.js에서 monsterNestManager를 직접 import하면 순환 참조 발생
**해결**: 동적 import를 사용하여 런타임에 모듈 로드

### 2. 라벨과 건물 겹침 문제
**문제**: 고블린과 시민 라벨이 건물과 겹쳐서 가독성 저하
**해결**: 라벨 위치를 0.9배율에서 1.5배율로 상승시켜 더 높게 배치

### 3. 가상 시민 관리 복잡성
**문제**: 가상 시민 생성과 관리 로직이 state.js에 산재
**해결**: MonsterNestManager 클래스로 모든 가상 시민 관련 로직 통합

### 4. 확장성 부족
**문제**: 다른 몬스터 종족이나 산적 추가 시 코드 수정이 복잡
**해결**: 팀 기반 관리 시스템으로 설계하여 쉽게 확장 가능

### 5. 코드 중복
**문제**: 몬스터 생산 로직이 여러 파일에 중복
**해결**: MonsterNestManager의 produceGoblin 메서드로 통합

---

## 몬스터 군락지 자동 생산 및 고블린 활동성 향상 작업 중 발생한 문제들 (2024-12-19)

### 1. 가상 시민 데이터 구조 설계
**문제**: 몬스터 군락지에 배치할 가상 시민의 데이터 구조 결정
**해결**: 기존 시민과 동일한 구조를 사용하되 숨김 상태로 설정하여 시각적으로는 보이지 않게 함

### 2. 가상 시민 스킬 설정
**문제**: 몬스터 생산에 필요한 스킬과 수련치 설정
**해결**: 몬스터 번식 스킬을 최대(10)로, 수련치를 최대(100)로 설정하여 효율적인 생산 보장

### 3. 고블린 활동성 조절
**문제**: 고블린이 너무 멀리 배회하거나 움직임이 적어 생동감 부족
**해결**: 배회 반경 축소, 도달 판정 거리 단축, 랜덤 목표 변경 확률 추가

### 4. 생산 시스템 통합
**문제**: 기존 생산 시스템과의 호환성 확보
**해결**: 가상 시민을 일반 시민과 동일하게 처리하여 기존 생산 로직 그대로 활용

### 5. 성능 최적화
**문제**: 고블린이 너무 자주 목표를 변경하면 성능에 영향
**해결**: 10% 확률로 제한하여 적절한 활동성과 성능의 균형 유지

---

## 고블린 시스템 고도화 및 팀 기반 건물 관리 작업 중 발생한 문제들 (2024-12-19)

### 1. 건물 팀 속성 누락
**문제**: 기존 건물들에 team 속성이 없어서 팀 구분이 안됨
**해결**: 건물 생성 시 자동으로 team: 0 (플레이어) 할당, 몬스터 군락지는 team: 1 할당

### 2. Inspector에서 팀 체크 로직 누락
**문제**: 모든 건물에 대해 동일한 인터페이스 표시
**해결**: 건물의 team 속성을 확인하여 우리팀이 아닌 경우 제한된 정보만 표시

### 3. 고블린 데이터 구조 불일치
**문제**: 고블린 생성 시 abilities와 stats 속성 혼재
**해결**: createRandomGoblin 함수에서 일관된 데이터 구조 사용

### 4. 홈 군락지 추적 시스템 구현
**문제**: 고블린이 어느 군락지에서 태어났는지 추적 불가
**해결**: goblinHomeNests Map을 사용하여 고블린 ID와 홈 군락지 ID 매핑

### 5. 순환 import 문제
**문제**: production.js에서 simpleMonsterSystem.js의 함수를 import할 때 순환 참조 가능성
**해결**: setGoblinHomeNest 함수를 export하여 안전하게 사용

### 6. 고블린 배회 반경 조정
**문제**: 고블린이 너무 멀리 배회하여 게임플레이에 방해
**해결**: 홈 군락지 주변 8미터 반경으로 제한하여 현실적인 배회 패턴 구현

---

## 2025-01-27

- 현상: 몬스터 시스템 통합 및 간소화 작업 중 발생한 문제들
  - 원인 및 해결:
    1) 몬스터 전용 파일들 삭제 후 import 오류
       - 조치: gameLoop.js에서 새로운 simpleMonsterSystem.js로 import 경로 변경
       - 결과: 기존 복잡한 몬스터 시스템 제거로 성능 개선
    2) EntityRenderer에서 몬스터와 시민 렌더링 통합 시 인덱스 충돌
       - 조치: 몬스터 인스턴스 인덱스를 시민 다음으로 배치하여 충돌 방지
       - 결과: 몬스터와 시민이 동일한 메쉬 사용으로 일관성 향상
    3) 팀 시스템 도입 시 기존 시민에 team 속성 누락
       - 조치: citizen.js의 createRandomCitizen 함수에 team: 0 속성 추가
       - 결과: 플레이어 소속 시민과 적 몬스터 구분 가능
    4) 몬스터 생산 시스템에서 자원 표시 오류
       - 조치: production.js에서 몬스터 생산 시 별도 처리 로직 추가
       - 결과: 몬스터 군락에서 고블린 생산 가능
    5) InteractionHandler에서 팀 체크 누락
       - 조치: 클릭 및 더블클릭 처리 시 team !== 0인 유닛 제외
       - 결과: 플레이어 소속 유닛만 조종 가능
    6) 몬스터 데이터 구조 불일치 (position vs pos, target vs moveTo)
       - 조치: 몬스터도 시민과 동일한 데이터 구조 사용하도록 통일
       - 결과: 몬스터와 시민이 완전히 동일한 시스템 사용
    7) 몬스터 이동 시스템 불일치
       - 조치: simpleMonsterSystem.js에서 시민과 동일한 moveEntity 함수 사용
       - 결과: 몬스터와 시민이 동일한 이동 애니메이션 및 스무딩 적용
  - 결과:
    - 몬스터와 시민의 완전한 시스템 통합으로 코드 복잡도 대폭 감소
    - 팀 시스템으로 게임 내 소속 구분 명확화
    - 간소화된 몬스터 AI로 성능 최적화
    - 몬스터 생산 시스템으로 게임플레이 다양성 증대
    - 시각적 일관성 향상으로 사용자 경험 개선

---

- 현상: 몬스터 시스템 구현 중 발생할 수 있는 문제들
  - 원인 및 예방:
    1) 몬스터 AI 상태 전환 시 무한 루프 가능성
       - 조치: 각 AI 상태별 명확한 종료 조건 설정 및 상태 전환 로직 검증
    2) 군락지 스폰 시 마을 범위 체크 실패
       - 조치: 마을 중심과 반경을 정확히 계산하여 충분한 거리 확보
    3) 몬스터 렌더링 시 메모리 누수
       - 조치: MonsterManager의 dispose 메서드에서 모든 메쉬와 인스턴스 정리
    4) 전투 시스템에서 대미지 계산 오류
       - 조치: 방어력과 공격력의 균형을 고려한 대미지 공식 검증
    5) 몬스터 AI 업데이트 시 성능 이슈
       - 조치: 몬스터 수 제한 및 업데이트 빈도 조절로 성능 최적화
  - 결과:
    - 안정적인 몬스터 시스템 구현으로 게임의 전략적 깊이 증대
    - 지형별 몬스터 분포로 탐험의 재미 제공
    - 군락지 시스템으로 장기적인 위협 요소 구현

---

- 현상: 게임 시작 직후 프레임 급락(렉)
  - 원인(복합):
    1) Scene3D 프레임 루프에서 매 프레임 라벨 전량 업데이트
    2) 라벨 매니저의 O(B*U) 스캔으로 유닛 수 증가 시 급격한 비용
    3) 상태 알림 `notify()` 다중 호출로 과도한 리렌더/씬 갱신
    4) 이벤트 리스너 바인딩이 매 인스턴스마다 새로 생성되어 dispose 미정합 가능성
  - 조치:
    - 라벨 업데이트를 구독 콜백으로 이동(상태 변경 시에만)
    - O(B+U)로 스캔 최적화(유닛 1회 순회→빌딩별 그룹화)
    - `notify()` coalescing 및 틱 배치 알림 적용
    - InteractionHandler의 리스너 바인딩 고정 및 정확한 해제 보장
  - 결과:
    - 시작 렉 해소, 틱/프레임 안정성 향상, 장시간 플레이 시 누수/스파이크 완화
 
## 2025-09-15

- 현상: 간헐적으로 그래픽이 깨지듯 잔상이 생겼다가 돌아오는 깜빡임
  - 원인(가능성):
    1) 캔버스가 `alpha:true`로 문서 배경과 합성될 때 클리어 순서/중첩 레이어에 따른 아티팩트
    2) 컴포넌트 언마운트 후에도 남아있는 `requestAnimationFrame` 중복 루프
  - 조치:
    - `WebGLRenderer`를 불투명(`alpha:false`)으로 전환, `setClearColor(0xeaf7ff,1)` 및 `autoClear=true` 명시
    - 렌더 루프에 `running` 플래그와 `rafId`를 도입하여 언마운트 시 `cancelAnimationFrame`로 정리
  - 결과:
    - 잔상/깜빡임 현상 재현 빈도 크게 감소, 탭 전환/리마운트 이후 안정성 향상
# TroubleShooting

## 2025-09-04

- 현상: `README.md`에 깨진 문자(라이선스 섹션 제목) 발견
  - 원인: 기존 문서 인코딩 상 이슈로 보임
  - 조치: "## 라이선스"로 교체하여 정규화

- 현상: `WalkingHuman3D.jsx` 발 위치가 경사면에서 미세 흔들림
  - 원인: 지면 노멀 근사(eps=0.5)로 인한 프레임별 샘플 변동
  - 조치: 발 Y는 groundHeight만 사용, 노멀은 몸 기울임 시에만 사용(향후 보완)

- 현상: `units` 미전달 시와 전달 시 애니메이션 속도 차이
  - 원인: 상태 기반일 때 `state`의 이동 속도와 보행 속도 매핑이 필요
  - 조치: 초안으로 `state`의 `u.state`에 따라 보행 강도 보정. 향후 속도 필드 매핑 예정

## 2025-01-12

- 현상: `Scene3D.jsx` 500 Internal Server Error로 로딩 실패
  - 원인: Scene3D.jsx 파일이 손상되어 import/export 구문이 없고 파일 구조가 불완전
  - 조치: Scene3D.jsx 파일을 완전히 새로 작성하여 복구

- 현상: `terrain.js` export 오류 (terrain이 export되지 않음)
  - 원인: `createTerrainSystem` 함수만 export하고 있었으나 Scene3D.jsx에서는 `terrain` 객체를 직접 import하려 함
  - 조치: terrain.js에 `export const terrain = createTerrainSystem();` 추가하여 기본 인스턴스 생성 후 export

- 현상: 건물 고스트(청사진) 메쉬가 보이지 않음
  - 원인: Scene3D.jsx 재작성 과정에서 고스트 메쉬 생성 로직이 누락됨
  - 조치: useEffect에서 state.ui.placing 상태에 따른 고스트 메쉬 생성/제거 로직 복구

- 현상: 마을 범위 겹침 시 자연스럽지 않은 표시
  - 원인: 다중 마을 회관의 범위가 겹칠 때 처리 로직이 부족
  - 조치: 겹치는 마을 범위의 투명도를 조정하여 자연스러운 합쳐진 효과 구현

- 현상: 마을 회관 건설 후 에이전트가 안 보임
  - 원인: 초기 시민 수가 0으로 설정되어 있어서 에이전트가 생성되지 않음
  - 조치: App.jsx에서 초기 시민 5명을 생성하도록 수정, construction.js의 기존 회관 건설 완료 시 시민 추가 로직은 이미 정상 작동

## 2024-12-19

- 현상: 건물이 선택한 위치와 다른 곳에 배치되거나 지형에 묻히는 문제
  - 원인: BuildingManager와 InteractionHandler에서 지형 높이를 고려하지 않음
  - 조치: 
    - BuildingManager에서 terrain.groundHeight()를 사용하여 건물 위치 계산
    - InteractionHandler에서 고스트 메쉬도 지형 높이를 고려하도록 수정
    - 건물이 지면에 올바르게 배치되도록 Y 위치 계산 개선

